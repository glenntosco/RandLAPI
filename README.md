
# üì¶ PRD: R&L Carrier BOL Integration with P4 Warehouse

## Overview

This service automates the creation of Bills of Lading (BOLs) in R&L Carriers from PickTickets generated by P4 Warehouse (P4W). It filters PickTickets where `Carrier = 'R&L CARRIERS'`, `PickTicketState != 'Closed'`, and `ProNumber IS NULL or EMPTY`, sends a properly formatted payload to the R&L API, and saves back the returned `ProNumber` into the P4W system.

## üéØ Goals

- ‚úÖ Pull eligible PickTickets from P4W via OData
- ‚úÖ POST BOL requests to R&L Carriers (external endpoint)
- ‚úÖ Save back the `ProNumber` on success
- ‚úÖ Run as a hosted .NET 9 background service
- ‚úÖ Use configurable base URLs and API keys via `appsettings.json` or injected `IOptions<T>`
- ‚úÖ Ensure full logging and safe error handling

## üß± Tech Stack

| Component      | Details                            |
|----------------|------------------------------------|
| Language       | C#                                 |
| Runtime        | .NET 9 (Long-Term Support)         |
| App Type       | Worker Service (Background Process)|
| Communication  | `HttpClient` + JSON (Newtonsoft)   |
| Auth           | API Key for P4W, API Key for R&L   |
| Hosting        | Windows Service, Container-Ready   |

## üìÅ Configuration Structure

```json
{
  "ServiceSettings": {
    "BaseUrl": "https://nadc218demo.p4warehouse.com/",
    "ApiKey": "358c2075-...+D7Y7kw==",
    "MaxRecordsPerCheck": 100,
    "CheckIntervalSeconds": 30
  },
  "RLCarrierSettings": {
    "BaseUrl": "https://apisandbox.rlc.com",
    "ApiKey": "ItO0YzFzIxZ1Q0MWQtZW.....kLTgxYzNGNiQlMzMTkTC",
    "Endpoint": "/BillOfLading"
  }
}
```

## üì° Source: P4W PickTicket OData

### Endpoint
```
GET /odata/PickTicket
```

### OData Filter
```
$filter=(Carrier eq 'R&L CARRIERS' and PickTicketState ne 'Closed' and (ProNumber eq null or ProNumber eq ''))
```

### Required Fields
- Id
- PickTicketNumber
- ProNumber
- Carrier
- PickTicketState

## üéØ Destination: R&L Carriers BOL API

### Endpoint
```
POST https://apisandbox.rlc.com/BillOfLading
```

### Headers
- Content-Type: application/json
- Authorization: API Key (ItO0YzFzIxZ1Q0MWQtZWNlZi00MDVkLTgxYzNGNiQlMzMTkTC)

### Minimal Valid Payload
```json
{
  "BillOfLading": {
    "BOLDate": "07/18/2025",
    "Shipper": {
      "CompanyName": "P4 Software Inc.",
      "AddressLine1": "3755 Breakthrough Way",
      "City": "Las Vegas",
      "StateOrProvince": "NV",
      "ZipOrPostalCode": "89135",
      "CountryCode": "USA",
      "PhoneNumber": "702-555-0101"
    },
    "Consignee": {
      "CompanyName": "Evergreen Logistics",
      "AddressLine1": "8400 NW 25th St",
      "City": "Doral",
      "StateOrProvince": "FL",
      "ZipOrPostalCode": "33198",
      "CountryCode": "USA"
    },
    "Items": [
      {
        "Class": "70",
        "Pieces": 8,
        "Weight": 960,
        "PackageType": "PLT",
        "Description": "Zebra Barcode Scanners and Mobile Computers"
      }
    ]
  }
}
```

### Response Payload
```json
{
  "ProNumber": "123456789",
  "Code": 200
}
```

## üîÑ Update P4W with ProNumber

### Endpoint
```
POST /api/PickTicketApi/CreateOrUpdate
```

### Payload
```json
{
  "Id": "guid",
  "ProNumber": "returned-pro-number"
}
```

## üîÅ Background Service Logic

1. Every N seconds (configurable), call GetPickTicketsAsync()
2. Filter for:
   Carrier == "R&L CARRIERS" AND PickTicketState != "Closed" AND (ProNumber is null OR empty)
3. For each result:
   - Construct BOL payload
   - Call R&L Carrier API
   - On success, retrieve ProNumber
   - Call /CreateOrUpdate to update ProNumber in P4W
4. Log successes, skips, and failures
5. Delay 100ms between calls to avoid throttling

## üß© Project Components

| File/Class                 | Description |
|---------------------------|-------------|
| PickTicketService.cs      | Handles GET and POST to P4W |
| PickTicketUpdateService.cs| Timer-driven background loop |
| RLCarrierService.cs       | NEW ‚Äî sends BOL JSON to R&L |
| RLCarrierSettings.cs      | NEW ‚Äî endpoint configuration class |
| RLCarrierBOLRequest.cs    | NEW ‚Äî request model to R&L |
| RLCarrierBOLResponse.cs   | NEW ‚Äî response model from R&L |
| PickTicket.cs             | Existing model for PickTicket |
| Program.cs                | Wire up DI and worker |

## üß™ Error Scenarios

| Scenario                         | Action |
|----------------------------------|--------|
| R&L API returns HTTP 400         | Log error, skip update |
| Missing ProNumber in response    | Log warning, do not update P4W |
| P4W update fails                 | Log error, continue processing others |
| No eligible PickTickets          | Log debug, wait next interval |

## üîí Security

- Store API keys in secrets.json, Azure Key Vault, or environment variables
- NEVER hardcode sensitive keys in source code
- Use retry logic for transient errors (optional)

## ‚úÖ Acceptance Criteria

- [ ] PickTickets with Carrier = R&L CARRIERS and no ProNumber are processed
- [ ] Valid BOL JSON sent to R&L API
- [ ] ProNumber saved back to P4W
- [ ] Logs clearly indicate success/failure/skipped
- [ ] R&L API endpoint is configurable after compile
- [ ] P4W API base URL and API key are configurable

## üöß Outstanding Questions

- Should Shipper/Consignee be static or dynamically pulled from PickTicket data?
- Should there be retry/backoff for failed R&L calls?
